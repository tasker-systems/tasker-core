# TypeScript FFI bundled native library path resolution broken in published package

## Problem

The `findBundledNativeLibrary()` function in `workers/typescript/src/ffi/ffi-layer.ts` cannot find the bundled native library in the published `@tasker-systems/tasker` npm package. Users must set `TASKER_FFI_LIBRARY_PATH` as a workaround.

### Root Cause

The path resolution assumes the code runs from `dist/ffi/ffi-layer.js` (unbundled):

```typescript
// This file lives in dist/ffi/ffi-layer.js at runtime.
// The native/ directory is at the package root (sibling to dist/).
const thisDir = dirname(fileURLToPath(import.meta.url));
const packageRoot = join(thisDir, '..', '..'); // dist/ffi/ → dist/ → package root
return join(packageRoot, 'native', filename);
```

But the published package bundles everything into `dist/index.js` (flat). So `import.meta.url` resolves to `dist/index.js`, and `../..` goes **one level too far**:

```
Expected (unbundled):   dist/ffi/ffi-layer.js → ../.. → package-root/
Actual (bundled):       dist/index.js          → ../.. → @tasker-systems/  (wrong!)
                        dist/index.js          → ..    → package-root/     (correct)
```

### Published Package Structure

```
@tasker-systems/tasker/
├── dist/
│   ├── index.js          ← main entry point (bundled)
│   ├── ffi/
│   │   └── index.js      ← also exists but NOT the import target
│   └── ...
├── native/
│   ├── libtasker_ts-darwin-arm64.dylib
│   ├── libtasker_ts-linux-x64.so
│   └── (linux-arm64 missing — separate issue?)
└── package.json          ← "main": "./dist/index.js"
```

### Verified

The native library files exist and are correct — only the path resolution is broken:

```bash
$ ls node_modules/@tasker-systems/tasker/native/
libtasker_ts-darwin-arm64.dylib  libtasker_ts-linux-x64.so
```

## Proposed Fix

Replace the hardcoded `../..` traversal with a walk-up search that works regardless of bundling depth:

```typescript
function findBundledNativeLibrary(): string | null {
  const key = `${process.platform}-${process.arch}`;
  const filename = BUNDLED_LIBRARIES[key];
  if (!filename) {
    return null;
  }

  // Walk up from the current file until we find the package root
  // (the directory containing native/). This works whether the code runs
  // from dist/ffi/ffi-layer.js (unbundled) or dist/index.js (bundled).
  let dir = dirname(fileURLToPath(import.meta.url));
  for (let i = 0; i < 5; i++) {
    const candidate = join(dir, 'native', filename);
    if (existsSync(candidate)) {
      return candidate;
    }
    const parent = dirname(dir);
    if (parent === dir) break; // reached filesystem root
    dir = parent;
  }
  return null;
}
```

## Workaround

Set the environment variable explicitly:

```bash
export TASKER_FFI_LIBRARY_PATH=/path/to/node_modules/@tasker-systems/tasker/native/libtasker_ts-darwin-arm64.dylib
```

## Additional Note

The `native/` directory in the published 0.1.3 package is missing `linux-arm64` — only `linux-x64` and `darwin-arm64` are present despite `BUNDLED_LIBRARIES` listing all three. This may be a separate build matrix issue.

## Metadata
- URL: [https://linear.app/tasker-systems/issue/TAS-282/typescript-ffi-bundled-native-library-path-resolution-broken-in](https://linear.app/tasker-systems/issue/TAS-282/typescript-ffi-bundled-native-library-path-resolution-broken-in)
- Identifier: TAS-282
- Status: In Progress
- Priority: High
- Assignee: Pete Taylor
- Project: [Road to Tasker Alpha](https://linear.app/tasker-systems/project/road-to-tasker-alpha-763400a12d53). Take Tasker from a codebase easy to develop on, to a project easy to use: published packages, cross-language SDKs, consumer docs, and bootstrap tooling.
- Project milestone: Phase 0: Foundation & Cleanup
- Created: 2026-02-15T17:37:53.766Z
- Updated: 2026-02-16T00:03:20.545Z
