#!/usr/bin/env bash
# =============================================================================
# Pre-commit hook: Auto-format staged Rust files with cargo fmt
# =============================================================================
#
# Installed via: git config core.hooksPath .githooks
# Skip once:     git commit --no-verify
#
# What this does:
#   1. Checks if any .rs files are staged (exits early if none)
#   2. Runs cargo fmt --all
#   3. Re-stages any formatted files that were already staged
#
# What this does NOT do (caught by CI instead):
#   - cargo clippy (slower, occasional false positives)
#   - Python/Ruby/TypeScript formatting
#   - Tests
# =============================================================================

# Exit gracefully if cargo is not available
if ! command -v cargo &>/dev/null; then
  exit 0
fi

# Check if any .rs files are staged
STAGED_RS_FILES=$(git diff --cached --name-only --diff-filter=ACM -- '*.rs')

if [ -z "$STAGED_RS_FILES" ]; then
  # No Rust files staged â€” nothing to format
  exit 0
fi

# Run cargo fmt on the whole workspace (fast, ~1 second)
cargo fmt --all 2>/dev/null

# Re-stage only .rs files that were already staged and got reformatted
for file in $STAGED_RS_FILES; do
  if [ -f "$file" ]; then
    git add "$file"
  fi
done

exit 0
