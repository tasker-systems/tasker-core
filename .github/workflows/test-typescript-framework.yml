name: TypeScript Framework & Client Tests

on:
  workflow_call:
    inputs:
      postgres-image:
        description: "PostgreSQL with PGMQ image tag"
        required: true
        type: string

jobs:
  typescript-framework:
    name: TypeScript Framework & Client Tests
    runs-on: ubuntu-22.04
    timeout-minutes: 20

    # PostgreSQL service for FFI bootstrap tests
    services:
      postgres:
        image: ${{ inputs.postgres-image }}
        env:
          POSTGRES_DB: tasker_rust_test
          POSTGRES_USER: tasker
          POSTGRES_PASSWORD: tasker
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U tasker -d tasker_rust_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      # TAS-156: Redis for distributed template cache
      redis:
        image: redis:7-alpine
        ports:
          - "6379:6379"
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    defaults:
      run:
        working-directory: workers/typescript

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Free up disk space
        uses: ./.github/actions/free-disk-space

      # ========================================================================
      # Setup runtimes for napi-rs FFI testing
      # ========================================================================
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Rust (for cargo-make + orchestration server)
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust build cache
        uses: ./.github/actions/setup-rust-cache

      - name: Setup shared environment variables
        uses: ./.github/actions/setup-env

      - name: Install protobuf compiler
        uses: ./.github/actions/install-protobuf

      - name: Install tools
        uses: ./.github/actions/install-tools
        with:
          tools: "sqlx-cli make"

      - name: Run database migrations
        run: cargo sqlx migrate run
        working-directory: .
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test

      - name: Install dependencies
        run: bun install --frozen-lockfile

      # ========================================================================
      # Download FFI library artifact from build-typescript job
      # ========================================================================
      - name: Download TypeScript artifacts
        uses: actions/download-artifact@v7
        with:
          name: typescript-artifacts
          path: artifacts/
        continue-on-error: true

      - name: Restore FFI module
        run: |
          cd ../..
          if [ -d artifacts ]; then
            ARTIFACTS_DIR=artifacts cargo-make/scripts/ci-restore-typescript-artifacts.sh
          else
            echo "No artifacts directory found, FFI tests may skip"
          fi
          # napi CLI places .node files in package root â€” FfiLayer auto-discovers them
          ls -la workers/typescript/tasker_ts.*.node 2>/dev/null || echo "No FFI module available"

      # ========================================================================
      # Quality Checks and Unit Tests (no FFI required)
      # ========================================================================
      - name: Run quality checks (lint + typecheck)
        run: |
          cargo make lint
          cargo make typecheck

      - name: Run TypeScript unit tests
        run: cargo make test-ci
        env:
          TASKER_ENV: test

      # ========================================================================
      # napi-rs FFI Integration Tests
      # ========================================================================
      - name: Run napi-rs FFI integration tests
        run: cargo make test-ffi
        env:
          TASKER_ENV: test
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test
          REDIS_URL: redis://localhost:6379
          FFI_BOOTSTRAP_TESTS: "true"
        continue-on-error: true

      # ========================================================================
      # Client API Integration Tests (TAS-284: merged from test-ffi-client.yml)
      # ========================================================================
      - name: Download core artifacts (for orchestration server)
        uses: actions/download-artifact@v7
        with:
          name: core-artifacts
          path: artifacts/core
        continue-on-error: true

      - name: Start orchestration server
        working-directory: .
        run: cargo-make/scripts/ci-start-orchestration-server.sh
        env:
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test
          REDIS_URL: redis://localhost:6379
          TASKER_ENV: test
          TASKER_TEMPLATE_PATH: ${{ github.workspace }}/tests/fixtures/task_templates
          SQLX_OFFLINE: "true"

      - name: Run TypeScript client API tests
        run: cargo make test-client-ci
        env:
          TASKER_ENV: test
          DATABASE_URL: postgresql://tasker:tasker@localhost:5432/tasker_rust_test
          REDIS_URL: redis://localhost:6379
          FFI_CLIENT_TESTS: "true"
          FFI_BOOTSTRAP_TESTS: "true"
          TASKER_ORCHESTRATION_URL: http://localhost:8080
          TASKER_CONFIG_PATH: ${{ github.workspace }}/config/tasker/generated/worker-test.toml
          TASKER_WEB_BIND_ADDRESS: "0.0.0.0:8182"
          TASKER_WORKER_GRPC_BIND_ADDRESS: "0.0.0.0:9182"
          TASKER_TEMPLATE_PATH: ${{ github.workspace }}/tests/fixtures/task_templates

      - name: Stop orchestration server
        if: always()
        working-directory: .
        run: cargo-make/scripts/ci-stop-orchestration-server.sh

      # ========================================================================
      # Build and Summary
      # ========================================================================
      - name: Run build
        run: bun run build

      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: typescript-framework-test-results
          path: |
            target/typescript-unit-results.txt
            target/typescript-client-results.txt
          if-no-files-found: warn

      - name: Display test summary
        if: always()
        working-directory: .
        run: cargo-make/scripts/ci-display-test-summary.sh typescript
