name: Release

on:
  push:
    tags:
      - 'release-*'
      - 'v*'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no actual publishing)'
        required: true
        type: boolean
        default: true
      from_ref:
        description: 'Base ref for change detection (optional, defaults to last release tag)'
        required: false
        type: string

# =============================================================================
# FORCED DRY-RUN MODE
# =============================================================================
# Set to 'false' when ready to enable real publishing.
# This overrides all jobs — even tag-triggered runs will only dry-run.
# =============================================================================
env:
  RELEASE_DRY_RUN: 'true'

concurrency:
  group: release
  cancel-in-progress: false

# =============================================================================
# Job DAG:
#
#   detect-and-calculate  (5 min)
#           |
#     pre-flight-check    (15 min) — fmt, clippy, cargo publish --dry-run
#           |
#     publish-crates      (20 min) — if core_changed
#           |
#     +----------+----------+
#     |          |          |
#  publish-   publish-   publish-
#  ruby       python     typescript
#  (20 min)   (20 min)   (15 min)
#     |          |          |
#     +----------+----------+
#           |
#     release-summary     — reports results
# =============================================================================

jobs:
  # ============================================================================
  # Stage 1: Detect changes and calculate versions
  # ============================================================================
  detect-and-calculate:
    name: Detect Changes & Calculate Versions
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    permissions:
      contents: read
    outputs:
      core_changed: ${{ steps.calc.outputs.CORE_CHANGED }}
      ffi_core_changed: ${{ steps.calc.outputs.FFI_CORE_CHANGED }}
      server_core_changed: ${{ steps.calc.outputs.SERVER_CORE_CHANGED }}
      ruby_changed: ${{ steps.calc.outputs.RUBY_CHANGED }}
      python_changed: ${{ steps.calc.outputs.PYTHON_CHANGED }}
      typescript_changed: ${{ steps.calc.outputs.TYPESCRIPT_CHANGED }}
      current_core_version: ${{ steps.calc.outputs.CURRENT_CORE_VERSION }}
      next_core_version: ${{ steps.calc.outputs.NEXT_CORE_VERSION }}
      next_ruby_version: ${{ steps.calc.outputs.NEXT_RUBY_VERSION }}
      next_python_version: ${{ steps.calc.outputs.NEXT_PYTHON_VERSION }}
      next_typescript_version: ${{ steps.calc.outputs.NEXT_TYPESCRIPT_VERSION }}
      is_dry_run: ${{ steps.dry-run.outputs.is_dry_run }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine dry-run mode
        id: dry-run
        run: |
          # Forced dry-run overrides everything
          if [[ "${{ env.RELEASE_DRY_RUN }}" == "true" ]]; then
            echo "is_dry_run=true" >> $GITHUB_OUTPUT
            echo "Forced dry-run mode enabled (RELEASE_DRY_RUN=true)"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "is_dry_run=${{ inputs.dry_run }}" >> $GITHUB_OUTPUT
            echo "Manual trigger: dry_run=${{ inputs.dry_run }}"
          else
            echo "is_dry_run=false" >> $GITHUB_OUTPUT
            echo "Tag-triggered release"
          fi

      - name: Calculate versions
        id: calc
        run: |
          EXTRA_ARGS=""
          if [[ -n "${{ inputs.from_ref }}" ]]; then
            EXTRA_ARGS="--from ${{ inputs.from_ref }}"
          fi

          # calculate-versions.sh outputs KEY=VALUE pairs; redirect to GITHUB_OUTPUT
          # shellcheck disable=SC2086
          ./scripts/release/calculate-versions.sh ${EXTRA_ARGS} >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "## Release Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Changed | Next Version |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|--------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Core (Rust) | ${{ steps.calc.outputs.CORE_CHANGED }} | ${{ steps.calc.outputs.NEXT_CORE_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Ruby | ${{ steps.calc.outputs.RUBY_CHANGED }} | ${{ steps.calc.outputs.NEXT_RUBY_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python | ${{ steps.calc.outputs.PYTHON_CHANGED }} | ${{ steps.calc.outputs.NEXT_PYTHON_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript | ${{ steps.calc.outputs.TYPESCRIPT_CHANGED }} | ${{ steps.calc.outputs.NEXT_TYPESCRIPT_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Dry run:** ${{ steps.dry-run.outputs.is_dry_run }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Stage 2: Pre-flight validation
  # ============================================================================
  pre-flight-check:
    name: Pre-flight Validation
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    needs: detect-and-calculate
    permissions:
      contents: read
    env:
      SQLX_OFFLINE: 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Setup Rust build cache
        uses: ./.github/actions/setup-rust-cache

      - name: Install protobuf compiler
        uses: ./.github/actions/install-protobuf

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Validate crate publishability
        run: |
          for crate in tasker-pgmq tasker-shared tasker-client tasker-orchestration tasker-worker tasker-cli; do
            echo "Validating ${crate}..."
            cargo publish -p "$crate" --dry-run --allow-dirty
          done

  # ============================================================================
  # Stage 3: Publish Rust crates
  # ============================================================================
  publish-crates:
    name: Publish Rust Crates
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    needs: [detect-and-calculate, pre-flight-check]
    if: needs.detect-and-calculate.outputs.core_changed == 'true'
    permissions:
      contents: write
    env:
      SQLX_OFFLINE: 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust build cache
        uses: ./.github/actions/setup-rust-cache

      - name: Install protobuf compiler
        uses: ./.github/actions/install-protobuf

      - name: Publish crates
        run: |
          DRY_RUN_FLAG=""
          if [[ "${{ needs.detect-and-calculate.outputs.is_dry_run }}" == "true" ]]; then
            DRY_RUN_FLAG="--dry-run"
          fi

          ./scripts/release/publish-crates.sh \
            "${{ needs.detect-and-calculate.outputs.next_core_version }}" \
            ${DRY_RUN_FLAG} \
            --on-duplicate=skip
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Tag core release
        if: needs.detect-and-calculate.outputs.is_dry_run != 'true'
        run: |
          VERSION="${{ needs.detect-and-calculate.outputs.next_core_version }}"
          git tag "core-v${VERSION}"
          git push origin "core-v${VERSION}"

  # ============================================================================
  # Stage 4: Publish FFI bindings (in parallel)
  # ============================================================================

  publish-ruby:
    name: Publish Ruby Gem
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    needs: [detect-and-calculate, pre-flight-check, publish-crates]
    # Run if ruby version is not 'unchanged', even if publish-crates was skipped
    if: |
      always() && !cancelled() && !failure() &&
      needs.detect-and-calculate.outputs.next_ruby_version != 'unchanged'
    permissions:
      contents: write
    env:
      SQLX_OFFLINE: 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
          bundler-cache: true
          working-directory: workers/ruby

      - name: Setup Rust build cache
        uses: ./.github/actions/setup-rust-cache

      - name: Install protobuf compiler
        uses: ./.github/actions/install-protobuf

      - name: Publish gem
        run: |
          DRY_RUN_FLAG=""
          if [[ "${{ needs.detect-and-calculate.outputs.is_dry_run }}" == "true" ]]; then
            DRY_RUN_FLAG="--dry-run"
          fi

          ./scripts/release/publish-ruby.sh \
            "${{ needs.detect-and-calculate.outputs.next_ruby_version }}" \
            ${DRY_RUN_FLAG} \
            --on-duplicate=skip
        env:
          GEM_HOST_API_KEY: ${{ secrets.RUBYGEMS_API_KEY }}

      - name: Tag ruby release
        if: needs.detect-and-calculate.outputs.is_dry_run != 'true'
        run: |
          VERSION="${{ needs.detect-and-calculate.outputs.next_ruby_version }}"
          git tag "ruby-v${VERSION}"
          git push origin "ruby-v${VERSION}"

  publish-python:
    name: Publish Python Package
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    needs: [detect-and-calculate, pre-flight-check, publish-crates]
    if: |
      always() && !cancelled() && !failure() &&
      needs.detect-and-calculate.outputs.next_python_version != 'unchanged'
    permissions:
      contents: write
      id-token: write
    environment: pypi
    env:
      SQLX_OFFLINE: 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: 'latest'

      - name: Setup Rust build cache
        uses: ./.github/actions/setup-rust-cache

      - name: Install protobuf compiler
        uses: ./.github/actions/install-protobuf

      - name: Publish package
        run: |
          DRY_RUN_FLAG=""
          if [[ "${{ needs.detect-and-calculate.outputs.is_dry_run }}" == "true" ]]; then
            DRY_RUN_FLAG="--dry-run"
          fi

          ./scripts/release/publish-python.sh \
            "${{ needs.detect-and-calculate.outputs.next_python_version }}" \
            ${DRY_RUN_FLAG} \
            --on-duplicate=skip

      - name: Tag python release
        if: needs.detect-and-calculate.outputs.is_dry_run != 'true'
        run: |
          VERSION="${{ needs.detect-and-calculate.outputs.next_python_version }}"
          git tag "python-v${VERSION}"
          git push origin "python-v${VERSION}"

  publish-typescript:
    name: Publish TypeScript Package
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    needs: [detect-and-calculate, pre-flight-check, publish-crates]
    if: |
      always() && !cancelled() && !failure() &&
      needs.detect-and-calculate.outputs.next_typescript_version != 'unchanged'
    permissions:
      contents: write
      id-token: write
    environment: npm
    env:
      SQLX_OFFLINE: 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Publish package
        run: |
          DRY_RUN_FLAG=""
          if [[ "${{ needs.detect-and-calculate.outputs.is_dry_run }}" == "true" ]]; then
            DRY_RUN_FLAG="--dry-run"
          fi

          ./scripts/release/publish-typescript.sh \
            "${{ needs.detect-and-calculate.outputs.next_typescript_version }}" \
            ${DRY_RUN_FLAG} \
            --on-duplicate=skip
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Tag typescript release
        if: needs.detect-and-calculate.outputs.is_dry_run != 'true'
        run: |
          VERSION="${{ needs.detect-and-calculate.outputs.next_typescript_version }}"
          git tag "typescript-v${VERSION}"
          git push origin "typescript-v${VERSION}"

  # ============================================================================
  # Stage 5: Release Summary
  # ============================================================================
  release-summary:
    name: Release Summary
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    needs: [detect-and-calculate, publish-crates, publish-ruby, publish-python, publish-typescript]
    if: always()
    permissions:
      contents: read
    steps:
      - name: Generate summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          DRY_RUN="${{ needs.detect-and-calculate.outputs.is_dry_run }}"
          if [[ "$DRY_RUN" == "true" ]]; then
            echo "> **DRY RUN** — No packages were actually published." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "| Component | Result | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Rust crates | ${{ needs.publish-crates.result }} | ${{ needs.detect-and-calculate.outputs.next_core_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Ruby gem | ${{ needs.publish-ruby.result }} | ${{ needs.detect-and-calculate.outputs.next_ruby_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python wheel | ${{ needs.publish-python.result }} | ${{ needs.detect-and-calculate.outputs.next_python_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript | ${{ needs.publish-typescript.result }} | ${{ needs.detect-and-calculate.outputs.next_typescript_version }} |" >> $GITHUB_STEP_SUMMARY

      - name: Check for failures
        run: |
          FAILED=false
          for result in "${{ needs.publish-crates.result }}" "${{ needs.publish-ruby.result }}" "${{ needs.publish-python.result }}" "${{ needs.publish-typescript.result }}"; do
            if [[ "$result" == "failure" ]]; then
              FAILED=true
            fi
          done

          if [[ "$FAILED" == "true" ]]; then
            echo "One or more publish jobs failed. Check individual job logs."
            exit 1
          fi
