name: Release

on:
  push:
    tags:
      - 'release-*'
      - 'v*'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no actual publishing)'
        required: true
        type: boolean
        default: true
      from_ref:
        description: 'Base ref for change detection (optional, defaults to last release tag)'
        required: false
        type: string

# =============================================================================
# FORCED DRY-RUN MODE
# =============================================================================
# Set to 'false' when ready to enable real publishing.
# This overrides all jobs — even tag-triggered runs will only dry-run.
# =============================================================================
env:
  RELEASE_DRY_RUN: 'false'

concurrency:
  group: release
  cancel-in-progress: false

# =============================================================================
# Job DAG:
#
#   detect-and-read       (5 min)
#           |
#     pre-flight-check    (15 min) — fmt, clippy, cargo publish --dry-run
#           |
#     publish-crates      (20 min) — if core_changed
#           |
#     +----------+----------+
#     |          |          |
#  publish-   publish-   publish-
#  ruby       python     typescript
#  (20 min)   (20 min)   (15 min)
#     |          |          |
#     +----------+----------+
#           |
#     release-summary     — reports results, creates GitHub Release
# =============================================================================

jobs:
  # ============================================================================
  # Stage 1: Read committed versions and detect changes for publish gating
  # ============================================================================
  detect-and-read:
    name: Read Versions & Detect Changes
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    permissions:
      contents: read
    outputs:
      core_changed: ${{ steps.detect.outputs.CORE_CHANGED }}
      ffi_core_changed: ${{ steps.detect.outputs.FFI_CORE_CHANGED }}
      server_core_changed: ${{ steps.detect.outputs.SERVER_CORE_CHANGED }}
      ruby_changed: ${{ steps.detect.outputs.RUBY_CHANGED }}
      python_changed: ${{ steps.detect.outputs.PYTHON_CHANGED }}
      typescript_changed: ${{ steps.detect.outputs.TYPESCRIPT_CHANGED }}
      core_version: ${{ steps.read.outputs.CORE_VERSION }}
      ruby_version: ${{ steps.read.outputs.RUBY_VERSION }}
      python_version: ${{ steps.read.outputs.PYTHON_VERSION }}
      typescript_version: ${{ steps.read.outputs.TYPESCRIPT_VERSION }}
      is_dry_run: ${{ steps.dry-run.outputs.is_dry_run }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine dry-run mode
        id: dry-run
        run: .github/scripts/release/determine-dry-run.sh
        env:
          RELEASE_DRY_RUN_OVERRIDE: ${{ env.RELEASE_DRY_RUN }}
          EVENT_NAME: ${{ github.event_name }}
          INPUT_DRY_RUN: ${{ inputs.dry_run }}

      - name: Read committed versions
        id: read
        run: ./scripts/release/read-versions.sh >> "$GITHUB_OUTPUT"

      - name: Detect changes for publish gating
        id: detect
        run: |
          EXTRA_ARGS=""
          if [[ -n "${{ inputs.from_ref }}" ]]; then
            EXTRA_ARGS="--from ${{ inputs.from_ref }}"
          fi
          # shellcheck disable=SC2086
          ./scripts/release/detect-changes.sh ${EXTRA_ARGS} >> "$GITHUB_OUTPUT"

      - name: Summary
        run: .github/scripts/release/detection-summary.sh
        env:
          CORE_CHANGED: ${{ steps.detect.outputs.CORE_CHANGED }}
          RUBY_CHANGED: ${{ steps.detect.outputs.RUBY_CHANGED }}
          PYTHON_CHANGED: ${{ steps.detect.outputs.PYTHON_CHANGED }}
          TS_CHANGED: ${{ steps.detect.outputs.TYPESCRIPT_CHANGED }}
          CORE_VERSION: ${{ steps.read.outputs.CORE_VERSION }}
          RUBY_VERSION: ${{ steps.read.outputs.RUBY_VERSION }}
          PYTHON_VERSION: ${{ steps.read.outputs.PYTHON_VERSION }}
          TS_VERSION: ${{ steps.read.outputs.TYPESCRIPT_VERSION }}
          IS_DRY_RUN: ${{ steps.dry-run.outputs.is_dry_run }}

  # ============================================================================
  # Stage 2: Pre-flight validation
  # ============================================================================
  pre-flight-check:
    name: Pre-flight Validation
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    needs: detect-and-read
    permissions:
      contents: read
    env:
      SQLX_OFFLINE: 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Setup Rust build cache
        uses: ./.github/actions/setup-rust-cache

      - name: Install protobuf compiler
        uses: ./.github/actions/install-protobuf

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Validate crate publishability
        run: .github/scripts/release/validate-publishability.sh

  # ============================================================================
  # Stage 3: Publish Rust crates
  # ============================================================================
  publish-crates:
    name: Publish Rust Crates
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    needs: [detect-and-read, pre-flight-check]
    if: needs.detect-and-read.outputs.core_changed == 'true'
    permissions:
      contents: write
    env:
      SQLX_OFFLINE: 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust build cache
        uses: ./.github/actions/setup-rust-cache

      - name: Install protobuf compiler
        uses: ./.github/actions/install-protobuf

      - name: Publish crates
        run: .github/scripts/release/publish-component.sh
        env:
          PUBLISH_SCRIPT: ./scripts/release/publish-crates.sh
          VERSION: ${{ needs.detect-and-read.outputs.core_version }}
          IS_DRY_RUN: ${{ needs.detect-and-read.outputs.is_dry_run }}
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Tag core release
        if: needs.detect-and-read.outputs.is_dry_run != 'true'
        run: .github/scripts/release/tag-component.sh
        env:
          COMPONENT: core
          VERSION: ${{ needs.detect-and-read.outputs.core_version }}

  # ============================================================================
  # Stage 4: Publish FFI bindings (in parallel)
  # ============================================================================

  publish-ruby:
    name: Publish Ruby Gem
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    needs: [detect-and-read, pre-flight-check, publish-crates]
    # Run if ruby or FFI core changed, even if publish-crates was skipped
    if: |
      always() && !cancelled() && !failure() &&
      (needs.detect-and-read.outputs.ruby_changed == 'true' ||
       needs.detect-and-read.outputs.ffi_core_changed == 'true')
    permissions:
      contents: write
      id-token: write
    environment: rbgem
    env:
      SQLX_OFFLINE: 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
          working-directory: workers/ruby

      - name: Install Ruby dependencies
        run: cd workers/ruby && bundle install --jobs 4

      - name: Setup Rust build cache
        uses: ./.github/actions/setup-rust-cache

      - name: Install protobuf compiler
        uses: ./.github/actions/install-protobuf

      - name: Build native extension and gem
        run: |
          cd workers/ruby
          bundle exec rake compile
          gem build tasker-rb.gemspec
        env:
          SQLX_OFFLINE: 'true'

      - name: Publish gem (OIDC)
        if: needs.detect-and-read.outputs.is_dry_run != 'true'
        uses: rubygems/release-gem@v1
        with:
          await-release: false

      - name: Dry-run publish
        if: needs.detect-and-read.outputs.is_dry_run == 'true'
        run: .github/scripts/release/publish-component.sh
        env:
          PUBLISH_SCRIPT: ./scripts/release/publish-ruby.sh
          VERSION: ${{ needs.detect-and-read.outputs.ruby_version }}
          IS_DRY_RUN: 'true'

      - name: Tag ruby release
        if: needs.detect-and-read.outputs.is_dry_run != 'true'
        run: .github/scripts/release/tag-component.sh
        env:
          COMPONENT: ruby
          VERSION: ${{ needs.detect-and-read.outputs.ruby_version }}

  publish-python:
    name: Publish Python Package
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    needs: [detect-and-read, pre-flight-check, publish-crates]
    if: |
      always() && !cancelled() && !failure() &&
      (needs.detect-and-read.outputs.python_changed == 'true' ||
       needs.detect-and-read.outputs.ffi_core_changed == 'true')
    permissions:
      contents: write
      id-token: write
    environment: pypi
    env:
      SQLX_OFFLINE: 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: 'latest'

      - name: Setup Rust build cache
        uses: ./.github/actions/setup-rust-cache

      - name: Install protobuf compiler
        uses: ./.github/actions/install-protobuf

      - name: Publish package
        run: .github/scripts/release/publish-component.sh
        env:
          PUBLISH_SCRIPT: ./scripts/release/publish-python.sh
          VERSION: ${{ needs.detect-and-read.outputs.python_version }}
          IS_DRY_RUN: ${{ needs.detect-and-read.outputs.is_dry_run }}

      - name: Tag python release
        if: needs.detect-and-read.outputs.is_dry_run != 'true'
        run: .github/scripts/release/tag-component.sh
        env:
          COMPONENT: python
          VERSION: ${{ needs.detect-and-read.outputs.python_version }}

  publish-typescript:
    name: Publish TypeScript Package
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    needs: [detect-and-read, pre-flight-check, publish-crates]
    if: |
      always() && !cancelled() && !failure() &&
      (needs.detect-and-read.outputs.typescript_changed == 'true' ||
       needs.detect-and-read.outputs.ffi_core_changed == 'true')
    permissions:
      contents: write
      id-token: write
    environment: npm
    env:
      SQLX_OFFLINE: 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Publish package
        run: .github/scripts/release/publish-component.sh
        env:
          PUBLISH_SCRIPT: ./scripts/release/publish-typescript.sh
          VERSION: ${{ needs.detect-and-read.outputs.typescript_version }}
          IS_DRY_RUN: ${{ needs.detect-and-read.outputs.is_dry_run }}

      - name: Tag typescript release
        if: needs.detect-and-read.outputs.is_dry_run != 'true'
        run: .github/scripts/release/tag-component.sh
        env:
          COMPONENT: typescript
          VERSION: ${{ needs.detect-and-read.outputs.typescript_version }}

  # ============================================================================
  # Stage 5: Release Summary
  # ============================================================================
  release-summary:
    name: Release Summary
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    needs: [detect-and-read, publish-crates, publish-ruby, publish-python, publish-typescript]
    if: always()
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Generate summary
        run: .github/scripts/release/generate-summary.sh
        env:
          IS_DRY_RUN: ${{ needs.detect-and-read.outputs.is_dry_run }}
          CRATES_RESULT: ${{ needs.publish-crates.result }}
          RUBY_RESULT: ${{ needs.publish-ruby.result }}
          PYTHON_RESULT: ${{ needs.publish-python.result }}
          TS_RESULT: ${{ needs.publish-typescript.result }}
          CORE_VERSION: ${{ needs.detect-and-read.outputs.core_version }}
          RUBY_VERSION: ${{ needs.detect-and-read.outputs.ruby_version }}
          PYTHON_VERSION: ${{ needs.detect-and-read.outputs.python_version }}
          TS_VERSION: ${{ needs.detect-and-read.outputs.typescript_version }}

      - name: Check for failures
        id: check-failures
        run: .github/scripts/release/check-failures.sh
        env:
          CRATES_RESULT: ${{ needs.publish-crates.result }}
          RUBY_RESULT: ${{ needs.publish-ruby.result }}
          PYTHON_RESULT: ${{ needs.publish-python.result }}
          TS_RESULT: ${{ needs.publish-typescript.result }}

      - name: Create GitHub Release
        if: |
          needs.detect-and-read.outputs.is_dry_run != 'true' &&
          steps.check-failures.outputs.has_failures != 'true'
        run: .github/scripts/release/create-github-release.sh
        env:
          GH_TOKEN: ${{ github.token }}
          CORE_VERSION: ${{ needs.detect-and-read.outputs.core_version }}
          CRATES_RESULT: ${{ needs.publish-crates.result }}
          RUBY_RESULT: ${{ needs.publish-ruby.result }}
          PYTHON_RESULT: ${{ needs.publish-python.result }}
          TS_RESULT: ${{ needs.publish-typescript.result }}
          RUBY_VERSION: ${{ needs.detect-and-read.outputs.ruby_version }}
          PYTHON_VERSION: ${{ needs.detect-and-read.outputs.python_version }}
          TS_VERSION: ${{ needs.detect-and-read.outputs.typescript_version }}

      - name: Log dry-run release (would have created)
        if: |
          needs.detect-and-read.outputs.is_dry_run == 'true' &&
          steps.check-failures.outputs.has_failures != 'true'
        run: .github/scripts/release/log-dry-run-release.sh
        env:
          CORE_VERSION: ${{ needs.detect-and-read.outputs.core_version }}
